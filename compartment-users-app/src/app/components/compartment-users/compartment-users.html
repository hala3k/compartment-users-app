<div class="forms-container">
  <div class="sync-status" *ngIf="syncStatus !== 'idle'">
    <span class="sync-indicator" [ngClass]="syncStatus">
      {{ syncMessage }}
    </span>
  </div>

  <div class="validation-status" [ngClass]="{'valid': isFormValid, 'invalid': !isFormValid}">
    <span *ngIf="isFormValid">Formular valid - toate compartimentele au cel putin un utilizator</span>
    <span *ngIf="!isFormValid">Formular invalid - fiecare compartiment trebuie sa aiba cel putin un utilizator</span>
  </div>

  <div class="form-card" *ngFor="let item of formItems; trackBy: trackByFormId" [ngClass]="{'valid-card': isItemValid(item), 'invalid-card': !isItemValid(item)}">
    <div class="form-header">
      <span class="form-title">Formular #{{ formItems.indexOf(item) + 1 }}</span>
      <div class="form-header-right">
        <span class="validity-badge" [ngClass]="{'valid': isItemValid(item), 'invalid': !isItemValid(item)}">
          {{ isItemValid(item) ? 'Valid' : 'Incomplet' }}
        </span>
        <button type="button" class="btn-delete" (click)="removeFormItem(item.id)" *ngIf="formItems.length > 1">Sterge</button>
      </div>
    </div>

    <form [formGroup]="item.form">
      <div class="form-group">
        <label>Compartiment *</label>
        <div class="autocomplete-wrapper">
          <input 
            type="text" 
            class="autocomplete-input" 
            [ngClass]="{'input-error': !item.form.get('compartment')?.value && item.form.get('compartment')?.touched}"
            placeholder="Cauta si selecteaza un compartiment..."
            [(ngModel)]="item.compartmentSearchTerm"
            [ngModelOptions]="{standalone: true}"
            (ngModelChange)="filterCompartments(item)"
            (focus)="onCompartmentFocus(item)"
            (blur)="onCompartmentBlur(item)"
            [disabled]="item.loading"
            autocomplete="off">
          <div class="autocomplete-dropdown" *ngIf="item.showCompartmentDropdown && !item.loading">
            <div 
              *ngFor="let compartment of item.filteredCompartments" 
              class="autocomplete-item"
              (mousedown)="selectCompartment(item, compartment)">
              {{ compartment }}
            </div>
            <div class="autocomplete-no-results" *ngIf="item.filteredCompartments.length === 0">
              Nu au fost gasite compartimente
            </div>
          </div>
        </div>
        <div class="error" *ngIf="!item.form.get('compartment')?.value && item.form.get('compartment')?.touched">
          Va rugam sa selectati un compartiment
        </div>
      </div>

      <div class="form-group" *ngIf="item.form.get('compartment')?.value">
        <label>Utilizatori * (Selectare multipla - minim 1)</label>
        
        <div class="selected-chips" [ngClass]="{'chips-error': getSelectedUsers(item).length === 0}">
          <div class="chip" *ngFor="let user of getSelectedUsers(item)">
            <span class="chip-text">{{ user.name }}</span>
            <button type="button" class="chip-remove" (click)="removeUser(item, user)" [title]="'Sterge ' + user.name">
              Ã—
            </button>
          </div>
          <span class="chips-placeholder" *ngIf="getSelectedUsers(item).length === 0">
            Niciun utilizator selectat
          </span>
        </div>
        
        <input 
          type="text" 
          class="search-input" 
          placeholder="Cauta utilizatori dupa nume sau email..."
          [(ngModel)]="item.userSearchTerm"
          [ngModelOptions]="{standalone: true}"
          (ngModelChange)="filterUsers(item)"
          *ngIf="!item.loadingUsers && item.users.length > 0">

        <div class="users-list" *ngIf="!item.loadingUsers && item.filteredUsers.length > 0">
          <div 
            *ngFor="let user of item.filteredUsers" 
            class="user-item"
            [class.selected]="isUserSelected(item, user)"
            (click)="toggleUser(item, user)">
            <input 
              type="checkbox" 
              [checked]="isUserSelected(item, user)"
              [id]="'user-' + item.id + '-' + user.id">
            <label [for]="'user-' + item.id + '-' + user.id" class="user-label">
              <strong>{{ user.name }}</strong>
              <span class="user-email">{{ user.email }}</span>
              <span class="user-org">{{ user.organisationName }}</span>
            </label>
            <span class="user-badge">{{ user.isGroup ? 'Grup' : 'Utilizator' }}</span>
          </div>
        </div>

        <div class="search-results" *ngIf="!item.loadingUsers && item.userSearchTerm && item.filteredUsers.length === 0 && item.users.length > 0">
          Nu au fost gasiti utilizatori
        </div>
        <div *ngIf="item.loadingUsers" class="loading">Se incarca utilizatorii...</div>
        <div *ngIf="!item.loadingUsers && item.users.length === 0 && item.form.get('compartment')?.value" class="no-data">
          Nu au fost gasiti utilizatori pentru acest compartiment.
        </div>
        <div class="error" *ngIf="getSelectedUsers(item).length === 0 && item.form.get('compartment')?.value">
          Va rugam sa selectati cel putin un utilizator.
        </div>
      </div>
    </form>
  </div>

  <button type="button" class="btn-add" (click)="addFormItem()">
    + Adauga Formular Nou
  </button>
</div>
