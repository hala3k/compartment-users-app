<div class="container">
  <h2>Compartment and Users Selection</h2>
  
  <form [formGroup]="form">
    <div class="form-group">
      <label for="compartment">Compartment *</label>
      <div class="autocomplete-wrapper">
        <input 
          type="text" 
          id="compartment"
          class="autocomplete-input" 
          placeholder="Search and select a compartment..."
          [(ngModel)]="compartmentSearchTerm"
          [ngModelOptions]="{standalone: true}"
          (ngModelChange)="filterCompartments()"
          (focus)="onCompartmentFocus()"
          (blur)="onCompartmentBlur()"
          (keydown)="onCompartmentKeyDown($event)"
          [disabled]="loading"
          autocomplete="off">
        <div class="autocomplete-dropdown" *ngIf="showCompartmentDropdown && !loading">
          <div 
            *ngFor="let compartment of filteredCompartments" 
            class="autocomplete-item"
            (click)="selectCompartment(compartment)">
            {{ compartment }}
          </div>
          <div class="autocomplete-no-results" *ngIf="filteredCompartments.length === 0">
            No compartments found
          </div>
        </div>
      </div>
      <div class="error" *ngIf="form.get('compartment')?.invalid && form.get('compartment')?.touched">
        Please select a compartment
      </div>
    </div>

    <div class="form-group" *ngIf="form.get('compartment')?.value">
      <label>Users * (Select multiple)</label>
      
      <div class="selected-chips" *ngIf="form.value.selectedUsers.length > 0">
        <div class="chip" *ngFor="let user of form.value.selectedUsers">
          <span class="chip-text">{{ user.name }}</span>
          <button type="button" class="chip-remove" (click)="removeUser(user)" title="Remove {{ user.name }}">
            Ã—
          </button>
        </div>
      </div>
      
      <input 
        type="text" 
        class="search-input" 
        placeholder="Search users by name or email..."
        [(ngModel)]="userSearchTerm"
        [ngModelOptions]="{standalone: true}"
        (ngModelChange)="filterUsers()"
        *ngIf="!loadingUsers && users.length > 0">
      <div class="users-list" *ngIf="!loadingUsers && filteredUsers.length > 0">
        <div 
          *ngFor="let user of filteredUsers" 
          class="user-item"
          [class.selected]="isUserSelected(user)"
          (click)="toggleUser(user)">
          <input 
            type="checkbox" 
            [checked]="isUserSelected(user)"
            [id]="'user-' + user.id">
          <label [for]="'user-' + user.id" class="user-label">
            <strong>{{ user.name }}</strong>
            <span class="user-id">ID: {{ user.id }}</span>
            <span class="user-email">{{ user.email }}</span>
          </label>
        </div>
      </div>
      <div class="search-results" *ngIf="!loadingUsers && userSearchTerm && filteredUsers.length === 0 && users.length > 0">
        No users found matching your search
      </div>
      <div *ngIf="loadingUsers" class="loading">Loading users...</div>
      <div *ngIf="!loadingUsers && users.length === 0" class="no-data">
        No users found for this compartment
      </div>
      <div class="error" *ngIf="form.get('selectedUsers')?.invalid && form.get('selectedUsers')?.touched">
        Please select at least one user
      </div>
    </div>
  </form>

  <div class="sync-status" *ngIf="syncStatus">
    <span class="sync-indicator" [class.syncing]="isSyncing" [class.success]="syncStatus.includes('success')" [class.error]="syncStatus.includes('failed')">
      {{ syncStatus }}
    </span>
  </div>

  <div class="form-value" *ngIf="form.value.compartment">
    <h3>Current Selection:</h3>
    <p><strong>Compartment:</strong> {{ form.value.compartment }}</p>
    <p><strong>Selected Users:</strong> {{ form.value.selectedUsers.length }} user(s)</p>
  </div>
</div>
