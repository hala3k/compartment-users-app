
<mat-spinner *ngIf="loading"></mat-spinner>
<div class="container" *ngIf="!isReadOnly">
  
  <form [formGroup]="form">
    <div class="form-group">
      <label for="compartment">Compartiment *</label>
      <div class="autocomplete-wrapper">
        <input 
          type="text" 
          id="compartment"
          class="autocomplete-input" 
          placeholder="Cauta si selecteaza un compartiment..."
          [(ngModel)]="compartmentSearchTerm"
          [ngModelOptions]="{standalone: true}"
          (ngModelChange)="filterCompartments()"
          (focus)="onCompartmentFocus()"
          (blur)="onCompartmentBlur()"
          (keydown)="onCompartmentKeyDown($event)"
          [disabled]="loading"
          autocomplete="off">
        <div class="autocomplete-dropdown" *ngIf="showCompartmentDropdown && !loading">
          <div 
            *ngFor="let compartment of filteredCompartments" 
            class="autocomplete-item"
            (click)="selectCompartment(compartment)">
            {{ ('setTenantComponent.subTenants.' + getLastGroup(compartment)) | translate }}
          </div>
          <div class="autocomplete-no-results" *ngIf="filteredCompartments.length === 0">
            Nu au fost gasite compartimente
          </div>
        </div>
      </div>
      <div class="error" *ngIf="form.get('compartment')?.invalid && form.get('compartment')?.touched">
        Va rugam sa selectati un compartiment
      </div>
    </div>

    <div class="form-group" *ngIf="form.get('compartment')?.value">
      <label>Useri * (Selectare multipla)</label>
      
      <div class="selected-chips" *ngIf="form.value.selectedUsers.length > 0">
        <div class="chip" *ngFor="let user of form.value.selectedUsers">
          <span class="chip-text">{{ user.name }}</span>
          <button type="button" class="chip-remove" (click)="removeUser(user)" title="Remove {{ user.name }}">
            Ã—
          </button>
        </div>
      </div>
      
      <input 
        type="text" 
        class="search-input" 
        placeholder="Cauta useri dupa nume sau email..."
        [(ngModel)]="userSearchTerm"
        [ngModelOptions]="{standalone: true}"
        (ngModelChange)="filterUsers()"
        *ngIf="!loadingUsers && users.length > 0">
      <div class="users-list" *ngIf="!loadingUsers && filteredUsers.length > 0">
        <div 
          *ngFor="let user of filteredUsers" 
          class="user-item"
          [class.selected]="isUserSelected(user)"
          (click)="toggleUser(user)">
          <input 
            type="checkbox" 
            [checked]="isUserSelected(user)"
            [id]="'user-' + user.id">
          <label [for]="'user-' + user.id" class="user-label">
            <strong>{{ user.name }}</strong>
            <span class="user-id">ID: {{ user.id }}</span>
            <span class="user-email">{{ user.email }}</span>
          </label>
        </div>
      </div>
      <div class="search-results" *ngIf="!loadingUsers && userSearchTerm && filteredUsers.length === 0 && users.length > 0">
        Nu au fost gasiti utilizatori
      </div>
      <div *ngIf="loadingUsers" class="loading">Loading users...</div>
      <div *ngIf="!loadingUsers && users.length === 0" class="no-data">
        Nu au fost gasiti utilizatori pentru acest compartiment.
      </div>
      <div class="error" *ngIf="form.get('selectedUsers')?.invalid && form.get('selectedUsers')?.touched">
        Va rugam sa selectati cel putin un utilizator.
      </div>
    </div>
  </form>
</div>
