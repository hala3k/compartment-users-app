<div class="forms-container">
  <div class="form-card" *ngFor="let item of formItems; trackBy: trackByFormId">
    <div class="form-header">
      <span class="form-title">Formular #{{ formItems.indexOf(item) + 1 }}</span>
      <button type="button" class="btn-delete" (click)="removeFormItem(item.id)">Sterge</button>
    </div>

    <form [formGroup]="item.form">
      <div class="form-group">
        <label>Compartiment *</label>
        <div class="autocomplete-wrapper">
          <input 
            type="text" 
            class="autocomplete-input" 
            placeholder="Cauta si selecteaza un compartiment..."
            [(ngModel)]="item.compartmentSearchTerm"
            [ngModelOptions]="{standalone: true}"
            (ngModelChange)="filterCompartments(item)"
            (focus)="onCompartmentFocus(item)"
            (blur)="onCompartmentBlur(item)"
            [disabled]="item.loading"
            autocomplete="off">
          <div class="autocomplete-dropdown" *ngIf="item.showCompartmentDropdown && !item.loading">
            <div 
              *ngFor="let compartment of item.filteredCompartments" 
              class="autocomplete-item"
              (mousedown)="selectCompartment(item, compartment)">
              {{ compartment }}
            </div>
            <div class="autocomplete-no-results" *ngIf="item.filteredCompartments.length === 0">
              Nu au fost gasite compartimente
            </div>
          </div>
        </div>
        <div class="error" *ngIf="item.form.get('compartment')?.invalid && item.form.get('compartment')?.touched">
          Va rugam sa selectati un compartiment
        </div>
      </div>

      <div class="form-group" *ngIf="item.form.get('compartment')?.value">
        <label>Utilizatori * (Selectare multipla)</label>
        
        <div class="selected-chips" *ngIf="getSelectedUsers(item).length > 0">
          <div class="chip" *ngFor="let user of getSelectedUsers(item)">
            <span class="chip-text">{{ user.name }}</span>
            <button type="button" class="chip-remove" (click)="removeUser(item, user)" [title]="'Sterge ' + user.name">
              Ã—
            </button>
          </div>
        </div>
        
        <input 
          type="text" 
          class="search-input" 
          placeholder="Cauta utilizatori dupa nume sau email..."
          [(ngModel)]="item.userSearchTerm"
          [ngModelOptions]="{standalone: true}"
          (ngModelChange)="filterUsers(item)"
          *ngIf="!item.loadingUsers && item.users.length > 0">

        <div class="users-list" *ngIf="!item.loadingUsers && item.filteredUsers.length > 0">
          <div 
            *ngFor="let user of item.filteredUsers" 
            class="user-item"
            [class.selected]="isUserSelected(item, user)"
            (click)="toggleUser(item, user)">
            <input 
              type="checkbox" 
              [checked]="isUserSelected(item, user)"
              [id]="'user-' + item.id + '-' + user.id">
            <label [for]="'user-' + item.id + '-' + user.id" class="user-label">
              <strong>{{ user.name }}</strong>
              <span class="user-email">{{ user.email }}</span>
              <span class="user-org">{{ user.organisationName }}</span>
            </label>
            <span class="user-badge">{{ user.isGroup ? 'Grup' : 'Utilizator' }}</span>
          </div>
        </div>

        <div class="search-results" *ngIf="!item.loadingUsers && item.userSearchTerm && item.filteredUsers.length === 0 && item.users.length > 0">
          Nu au fost gasiti utilizatori
        </div>
        <div *ngIf="item.loadingUsers" class="loading">Se incarca utilizatorii...</div>
        <div *ngIf="!item.loadingUsers && item.users.length === 0 && item.form.get('compartment')?.value" class="no-data">
          Nu au fost gasiti utilizatori pentru acest compartiment.
        </div>
        <div class="error" *ngIf="item.form.get('selectedUsers')?.invalid && item.form.get('selectedUsers')?.touched">
          Va rugam sa selectati cel putin un utilizator.
        </div>
      </div>
    </form>
  </div>

  <button type="button" class="btn-add" (click)="addFormItem()">
    + Adauga Formular Nou
  </button>

  <button 
    type="button" 
    class="btn-sync" 
    *ngIf="hasSelectedUsers()"
    (click)="syncAll()">
    Sincronizeaza Toate Formularele
  </button>
</div>
